<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.Button?>
<?import javafx.scene.control.Label?>
<?import javafx.scene.control.ScrollPane?>
<?import javafx.scene.control.TextField?>
<?import javafx.scene.control.ToggleButton?>
<?import javafx.scene.layout.HBox?>
<?import javafx.scene.layout.Region?>
<?import javafx.scene.layout.StackPane?>
<?import javafx.scene.layout.VBox?>
<?import javafx.scene.web.WebView?>

<StackPane xmlns="http://javafx.com/javafx/21"
           xmlns:fx="http://javafx.com/fxml/1"
           fx:controller="controllers.front.evenements.PaiementController"
           styleClass="payRoot"
           stylesheets="@/styles/evenements/paiement-view.css">

    <!-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— -->
    <!-- â•‘  LAYER 1 â€” MAIN CONTENT (formulaires)                â•‘ -->
    <!-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <ScrollPane fx:id="mainScroll" fitToWidth="true" hbarPolicy="NEVER"
                vbarPolicy="AS_NEEDED" styleClass="payScroll">
        <content>
            <VBox spacing="18" styleClass="payMainContent">
                <padding><Insets top="14" right="14" bottom="18" left="14"/></padding>

                <!-- â”€â”€ TOP BAR â”€â”€ -->
                <HBox alignment="CENTER_LEFT" spacing="12" styleClass="payTopBar">
                    <Button text="â† Retour" onAction="#goBack" styleClass="payBackBtn"/>
                    <Region HBox.hgrow="ALWAYS"/>
                    <Label text="ðŸ’³ Paiement" styleClass="payPageTitle"/>
                </HBox>

                <!-- â”€â”€ MODE INDICATOR â”€â”€ -->
                <Label fx:id="modeLabel" text="" styleClass="payModeLabel" wrapText="true"/>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• RÃ‰CAP â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <VBox spacing="10" styleClass="payCard">
                    <Label text="ðŸ“‹ RÃ©capitulatif" styleClass="payCardTitle"/>
                    <HBox spacing="8" alignment="CENTER_LEFT">
                        <Label text="Ã‰vÃ©nement :" styleClass="payLabel"/>
                        <Label fx:id="recapTitre" text="â€”" styleClass="payValue"/>
                    </HBox>
                    <HBox spacing="8" alignment="CENTER_LEFT">
                        <Label text="Dates :" styleClass="payLabel"/>
                        <Label fx:id="recapDates" text="â€”" styleClass="payValueMuted"/>
                    </HBox>
                    <HBox spacing="8" alignment="CENTER_LEFT">
                        <Label text="Tickets :" styleClass="payLabel"/>
                        <Label fx:id="recapTickets" text="â€”" styleClass="payValue"/>
                    </HBox>
                    <HBox spacing="8" alignment="CENTER_LEFT" styleClass="payTotalRow">
                        <Label text="Total Ã  payer :" styleClass="payTotalLabel"/>
                        <Region HBox.hgrow="ALWAYS"/>
                        <Label fx:id="recapTotal" text="0,00 TND" styleClass="payTotalValue"/>
                    </HBox>
                </VBox>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• MÃ‰THODE DE PAIEMENT â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <VBox spacing="10" styleClass="payCard">
                    <Label text="ðŸ’° MÃ©thode de paiement" styleClass="payCardTitle"/>

                    <HBox spacing="10" alignment="CENTER_LEFT" styleClass="payMethodeRow">
                        <ToggleButton fx:id="btnCarte"    text="ðŸ’³ Carte"    styleClass="payMethodeBtn"/>
                        <ToggleButton fx:id="btnEspeces"  text="ðŸ’µ EspÃ¨ces"  styleClass="payMethodeBtn"/>
                        <ToggleButton fx:id="btnVirement" text="ðŸ¦ Virement" styleClass="payMethodeBtn"/>
                        <ToggleButton fx:id="btnFlouci"   text="ðŸ“± Flouci"   styleClass="payMethodeBtn"/>
                        <ToggleButton fx:id="btnCrypto"   text="â‚¿ Crypto"    styleClass="payMethodeBtn"/>
                    </HBox>

                    <!-- â”€â”€ FORM : CARTE BANCAIRE â”€â”€ -->
                    <VBox fx:id="formCarte" spacing="10" visible="false" managed="false"
                          styleClass="payFormSection">

                        <!-- Note API (visible uniquement si Stripe est configurÃ©) -->
                        <Label fx:id="carteApiNote" visible="false" managed="false"
                               text="ðŸ”’ Paiement sÃ©curisÃ© via Stripe â€” Vous serez redirigÃ© vers la page Stripe Checkout."
                               wrapText="true" styleClass="payApiNote"/>

                        <!-- Champs locaux (masquÃ©s quand Stripe est configurÃ©) -->
                        <VBox fx:id="carteFieldsBox" spacing="10">
                            <Label text="Nom sur la carte" styleClass="payFieldLabel"/>
                            <TextField fx:id="carteNom" promptText="Jean Dupont" styleClass="payField"/>
                            <Label text="NumÃ©ro de carte" styleClass="payFieldLabel"/>
                            <TextField fx:id="carteNumero" promptText="4242 4242 4242 4242" styleClass="payField"/>
                            <HBox spacing="12">
                                <VBox spacing="4" HBox.hgrow="ALWAYS">
                                    <Label text="Expiration (MM/YY)" styleClass="payFieldLabel"/>
                                    <TextField fx:id="carteExpiry" promptText="12/26" styleClass="payField"/>
                                </VBox>
                                <VBox spacing="4" HBox.hgrow="ALWAYS">
                                    <Label text="CVV" styleClass="payFieldLabel"/>
                                    <TextField fx:id="carteCvv" promptText="123" styleClass="payField"/>
                                </VBox>
                            </HBox>
                        </VBox>
                    </VBox>

                    <!-- â”€â”€ FORM : ESPÃˆCES â”€â”€ -->
                    <VBox fx:id="formEspeces" spacing="10" visible="false" managed="false"
                          styleClass="payFormSection">
                        <Label text="ðŸ’µ Paiement en espÃ¨ces" styleClass="payFieldLabel"/>
                        <Label text="Rendez-vous au guichet de l'Ã©vÃ©nement avec le montant exact. Votre paiement sera confirmÃ© sur place."
                               wrapText="true" styleClass="payHint"/>
                    </VBox>

                    <!-- â”€â”€ FORM : VIREMENT â”€â”€ -->
                    <VBox fx:id="formVirement" spacing="10" visible="false" managed="false"
                          styleClass="payFormSection">
                        <Label text="RÃ©fÃ©rence de virement" styleClass="payFieldLabel"/>
                        <TextField fx:id="virementRef" promptText="RÃ©fÃ©rence bancaire" styleClass="payField"/>
                        <Label text="Effectuez un virement avec la rÃ©fÃ©rence ci-dessus vers le RIB affichÃ© dans votre confirmation."
                               wrapText="true" styleClass="payHint"/>
                    </VBox>

                    <!-- â”€â”€ FORM : FLOUCI â”€â”€ -->
                    <VBox fx:id="formFlouci" spacing="10" visible="false" managed="false"
                          styleClass="payFormSection">

                        <!-- Note API (visible uniquement si Flouci sandbox est configurÃ©) -->
                        <Label fx:id="flouciApiNote" visible="false" managed="false"
                               text="ðŸ“± Paiement via Flouci â€” Vous serez redirigÃ© vers la page Flouci pour finaliser."
                               wrapText="true" styleClass="payApiNote"/>

                        <!-- Champs locaux (masquÃ©s quand Flouci est configurÃ©) -->
                        <VBox fx:id="flouciFieldsBox" spacing="10">
                            <Label text="NumÃ©ro de tÃ©lÃ©phone Flouci" styleClass="payFieldLabel"/>
                            <TextField fx:id="flouciPhone" promptText="22 345 678" styleClass="payField"/>
                            <Label text="Vous recevrez une notification Flouci pour confirmer le paiement."
                                   wrapText="true" styleClass="payHint"/>
                        </VBox>
                    </VBox>

                    <!-- â”€â”€ FORM : CRYPTO â”€â”€ -->
                    <VBox fx:id="formCrypto" spacing="12" visible="false" managed="false"
                          styleClass="payFormSection">

                        <Label text="Choisissez une crypto-monnaie" styleClass="payFieldLabel"/>
                        <HBox spacing="10" alignment="CENTER_LEFT">
                            <ToggleButton fx:id="btnBTC" text="â‚¿ Bitcoin (BTC)"
                                          styleClass="payMethodeBtn"/>
                            <ToggleButton fx:id="btnETH" text="âŸ  Ethereum (ETH)"
                                          styleClass="payMethodeBtn"/>
                        </HBox>

                        <!-- Loading pendant l'appel CoinGecko -->
                        <Label fx:id="cryptoLoadingLabel" text="â³ RÃ©cupÃ©ration du taux en cours..."
                               visible="false" managed="false" styleClass="payHint"/>

                        <!-- DÃ©tails crypto (adresse + montant) -->
                        <VBox fx:id="cryptoDetails" spacing="10" visible="false" managed="false"
                              styleClass="payCryptoCard">

                            <Label text="Adresse de rÃ©ception :" styleClass="payFieldLabel"/>
                            <HBox spacing="8" alignment="CENTER_LEFT">
                                <TextField fx:id="cryptoAddress" editable="false"
                                           styleClass="payField" HBox.hgrow="ALWAYS"/>
                                <Button text="ðŸ“‹ Copier" onAction="#copyCryptoAddress"
                                        styleClass="payCopyBtn"/>
                            </HBox>

                            <Label text="Montant exact Ã  envoyer :" styleClass="payFieldLabel"/>
                            <Label fx:id="cryptoAmount" text="â€”" styleClass="payCryptoAmount"/>
                            <Label fx:id="cryptoRate" text="" styleClass="payValueMuted"/>

                            <Label text="âš ï¸ Envoyez le montant EXACT Ã  l'adresse ci-dessus. Le paiement sera vÃ©rifiÃ© manuellement."
                                   wrapText="true" styleClass="payHint"/>
                        </VBox>
                    </VBox>
                </VBox>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• ERREUR + CONFIRMER â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <VBox spacing="10" alignment="CENTER">
                    <Label fx:id="errorLabel" text="" visible="false" managed="false"
                           styleClass="payError" wrapText="true"/>
                    <Button fx:id="payerBtn" text="Confirmer le paiement"
                            onAction="#handlePayer" styleClass="payConfirmBtn"
                            prefWidth="320"/>
                </VBox>
            </VBox>
        </content>
    </ScrollPane>

    <!-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— -->
    <!-- â•‘  LAYER 2 â€” WEBVIEW (Stripe Checkout / Flouci)        â•‘ -->
    <!-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <VBox fx:id="webViewPane" visible="false" managed="false" styleClass="payWebViewPane">
        <HBox alignment="CENTER_LEFT" spacing="12" styleClass="payWebTopBar">
            <padding><Insets top="8" right="14" bottom="8" left="14"/></padding>
            <Label text="ðŸ”’ Paiement sÃ©curisÃ©" styleClass="payWebTitle"/>
            <Region HBox.hgrow="ALWAYS"/>
            <Button text="âœ• Annuler" onAction="#cancelWebPayment" styleClass="payWebCancelBtn"/>
        </HBox>
        <WebView fx:id="paymentWebView" VBox.vgrow="ALWAYS"/>
    </VBox>

    <!-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— -->
    <!-- â•‘  LAYER 3 â€” LOADING                                   â•‘ -->
    <!-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <VBox fx:id="loadingPane" spacing="14" alignment="CENTER"
          visible="false" managed="false" styleClass="payLoadingPane">
        <Label text="â³" styleClass="payLoadingIcon"/>
        <Label fx:id="loadingText" text="Traitement du paiement en cours..."
               styleClass="payLoadingText"/>
        <Label text="Veuillez patienter" styleClass="payLoadingHint"/>
    </VBox>

    <!-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— -->
    <!-- â•‘  LAYER 4 â€” REÃ‡U DE CONFIRMATION                     â•‘ -->
    <!-- â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <VBox fx:id="recuPane" spacing="16" alignment="CENTER"
          visible="false" managed="false" styleClass="payRecuPane">
        <Label text="âœ…" styleClass="payRecuIcon"/>
        <Label text="Paiement confirmÃ© !" styleClass="payRecuTitle"/>
        <VBox spacing="8" styleClass="payRecuCard">
            <HBox spacing="8" alignment="CENTER_LEFT">
                <Label text="RÃ©fÃ©rence :" styleClass="payLabel"/>
                <Label fx:id="recuRef" text="â€”" styleClass="payValue"/>
            </HBox>
            <HBox spacing="8" alignment="CENTER_LEFT">
                <Label text="Montant :" styleClass="payLabel"/>
                <Label fx:id="recuMontant" text="â€”" styleClass="payTotalValue"/>
            </HBox>
            <HBox spacing="8" alignment="CENTER_LEFT">
                <Label text="MÃ©thode :" styleClass="payLabel"/>
                <Label fx:id="recuMethode" text="â€”" styleClass="payValue"/>
            </HBox>
            <HBox spacing="8" alignment="CENTER_LEFT">
                <Label text="Date :" styleClass="payLabel"/>
                <Label fx:id="recuDate" text="â€”" styleClass="payValueMuted"/>
            </HBox>
        </VBox>
        <Button text="Retour Ã  l'Ã©vÃ©nement" onAction="#handleRetourEvenement"
                styleClass="payConfirmBtn" prefWidth="260"/>
    </VBox>
</StackPane>
