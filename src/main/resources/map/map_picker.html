<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sélecteur de Localisation</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; height: 100vh; background-color: #f5f5f5; }
        #map { width: 100%; height: 100%; z-index: 1; }

        .info-panel{
            position:absolute; bottom:20px; left:20px; background:white; padding:15px;
            border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.15);
            z-index:1000; max-width:340px;
        }
        .info-panel h3{ margin-bottom:8px; color:#333; }
        .info-panel p{ color:#666; font-size:12px; margin:6px 0; }
        .coordinates{
            background:#f9f9f9; padding:8px; border-radius:6px; font-family:monospace; font-size:11px; margin-top:8px;
        }
        .address{
            margin-top:8px; font-size:11px; color:#444; line-height:1.25;
            max-height:56px; overflow:hidden;
        }
        .button-group{ position:absolute; top:20px; right:20px; z-index:1000; }
        button{
            background:#007bff; color:#fff; border:none; padding:10px 14px; margin:5px;
            border-radius:8px; cursor:pointer; font-size:12px; font-weight:700;
            box-shadow:0 2px 8px rgba(0,0,0,0.15);
        }
        button:hover{ background:#0056b3; }
        button.secondary{ background:#6c757d; }
        button.secondary:hover{ background:#5a6268; }
    </style>
</head>
<body>
<div id="map"></div>

<div class="info-panel">
    <h3>Sélection de Localisation</h3>
    <p>Cliquez sur la carte pour choisir une localisation</p>

    <div class="coordinates">
        <div>Latitude: <span id="lat">-</span></div>
        <div>Longitude: <span id="lng">-</span></div>
    </div>

    <div class="address" id="addr">Adresse: -</div>
</div>

<div class="button-group">
    <button id="confirmBtn">Valider</button>
    <button id="clearBtn" class="secondary">Réinitialiser</button>
</div>

<script>
    let selectedLocation = null;
    let marker = null;
    let selectedAddress = "";

    const map = L.map("map").setView([33.8869, 9.5375], 7);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 19,
    }).addTo(map);

    async function reverseGeocode(lat, lng) {
        try {
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
            const res = await fetch(url, {
                headers: { "Accept-Language": "fr" }
            });
            const data = await res.json();
            return data && data.display_name ? data.display_name : "";
        } catch (e) {
            return "";
        }
    }

    function publishToJavaFX(lat, lng, address) {
        // IMPORTANT: on encode une info stable pour JavaFX via document.title
        // Format: "lat,lng|address"
        const coords = `${lat.toFixed(6)},${lng.toFixed(6)}`;
        const addr = (address || "").replace(/\s+/g, " ").trim();
        document.title = addr ? `${coords}|${addr}` : coords;
    }

    map.on("click", async function (e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;

        if (marker) map.removeLayer(marker);

        marker = L.marker([lat, lng]).addTo(map)
            .bindPopup(`<b>Position sélectionnée</b><br>Lat: ${lat.toFixed(4)}<br>Lng: ${lng.toFixed(4)}`)
            .openPopup();

        document.getElementById("lat").textContent = lat.toFixed(6);
        document.getElementById("lng").textContent = lng.toFixed(6);

        selectedLocation = { latitude: lat, longitude: lng };

        // Reverse geocode (adresse)
        selectedAddress = await reverseGeocode(lat, lng);
        document.getElementById("addr").textContent = selectedAddress ? ("Adresse: " + selectedAddress) : "Adresse: -";

        // On publie immédiatement à JavaFX (même sans Valider)
        publishToJavaFX(lat, lng, selectedAddress);
    });

    document.getElementById("confirmBtn").addEventListener("click", function () {
        if (!selectedLocation) {
            alert("Veuillez sélectionner une localisation sur la carte");
            return;
        }
        // Re-publier (au cas où)
        publishToJavaFX(selectedLocation.latitude, selectedLocation.longitude, selectedAddress);
    });

    document.getElementById("clearBtn").addEventListener("click", function () {
        if (marker) {
            map.removeLayer(marker);
            marker = null;
        }
        selectedLocation = null;
        selectedAddress = "";
        document.getElementById("lat").textContent = "-";
        document.getElementById("lng").textContent = "-";
        document.getElementById("addr").textContent = "Adresse: -";
        document.title = "Sélecteur de Localisation";
    });

    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(function (position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            map.setView([lat, lng], 12);
        });
    }
</script>
</body>
</html>