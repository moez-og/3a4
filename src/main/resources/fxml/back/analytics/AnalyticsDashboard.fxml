<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.Label?>
<?import javafx.scene.control.ScrollPane?>
<?import javafx.scene.control.Tooltip?>
<?import javafx.scene.layout.ColumnConstraints?>
<?import javafx.scene.layout.GridPane?>
<?import javafx.scene.layout.HBox?>
<?import javafx.scene.layout.Region?>
<?import javafx.scene.layout.RowConstraints?>
<?import javafx.scene.layout.StackPane?>
<?import javafx.scene.layout.VBox?>
<?import javafx.scene.shape.Rectangle?>

<StackPane xmlns="http://javafx.com/javafx/21"
           xmlns:fx="http://javafx.com/fxml/1"
           fx:controller="controllers.back.analytics.AnalyticsDashboardController"
           stylesheets="@/styles/back/analytics.css">

    <!-- Contenu principal -->
    <ScrollPane fitToWidth="true" hbarPolicy="NEVER" vbarPolicy="AS_NEEDED" styleClass="analyticsScroll">
        <content>
            <VBox fx:id="rootBox" spacing="20" styleClass="analyticsRoot">
                <padding><Insets top="20" right="24" bottom="28" left="24"/></padding>

                <!-- â•â• EN-TÃŠTE â•â• -->
                <VBox spacing="4">
                    <Label text="ðŸ”¬  Analyse comportementale des favoris" styleClass="pageTitle"/>
                    <Label text="Heatmap Ã‚ge Ã— CatÃ©gorie Â· Score pondÃ©rÃ© Â· Pearson Â· Shannon entropy"
                           styleClass="pageSubtitle"/>
                </VBox>

                <!-- â•â• KPI CARDS â•â• -->
                <HBox spacing="14">
                    <VBox styleClass="kpiCard" HBox.hgrow="ALWAYS">
                        <Label text="Favoris total" styleClass="kpiCardTitle"/>
                        <Label fx:id="kpiFavoris" text="â€”" styleClass="kpiCardValue"/>
                        <Label text="entrÃ©es favori_lieu" styleClass="kpiCardSub"/>
                    </VBox>
                    <VBox styleClass="kpiCard" HBox.hgrow="ALWAYS">
                        <Label text="Users actifs" styleClass="kpiCardTitle"/>
                        <Label fx:id="kpiUsers" text="â€”" styleClass="kpiCardValue"/>
                        <Label text="ont â‰¥ 1 favori" styleClass="kpiCardSub"/>
                    </VBox>
                    <VBox styleClass="kpiCard" HBox.hgrow="ALWAYS">
                        <Label text="Lieux favorisÃ©s" styleClass="kpiCardTitle"/>
                        <Label fx:id="kpiLieux" text="â€”" styleClass="kpiCardValue"/>
                        <Label text="lieux distincts" styleClass="kpiCardSub"/>
                    </VBox>
                    <VBox styleClass="kpiCard" HBox.hgrow="ALWAYS">
                        <Label text="Engagement" styleClass="kpiCardTitle"/>
                        <Label fx:id="kpiMoyenne" text="â€”" styleClass="kpiCardValue"/>
                        <Label text="moyenne par utilisateur" styleClass="kpiCardSub"/>
                    </VBox>
                </HBox>

                <!-- â•â• HEATMAP Ã‚GE Ã— CATÃ‰GORIE â•â• -->
                <VBox fx:id="heatmapSection" spacing="12" styleClass="sectionCard">

                    <HBox alignment="CENTER_LEFT" spacing="10">
                        <VBox spacing="3">
                            <Label text="ðŸ”¥  Heatmap  Ã‚ge Ã— CatÃ©gorie" styleClass="sectionTitle"/>
                            <Label text="IntensitÃ© = nombre de favoris dans chaque segment (tranche d'Ã¢ge Ã— type de lieu)"
                                   styleClass="sectionSubtitle"/>
                        </VBox>
                        <Region HBox.hgrow="ALWAYS"/>
                        <VBox spacing="4" alignment="CENTER_RIGHT">
                            <Label text="IntensitÃ©" styleClass="legendTitle"/>
                            <HBox spacing="6" alignment="CENTER">
                                <Label fx:id="heatmapLegendMin" text="0" styleClass="legendVal"/>
                                <Rectangle width="120" height="10" arcWidth="5" arcHeight="5"
                                           style="-fx-fill: linear-gradient(to right, #eff6ff, #3b82f6, #1e40af);"/>
                                <Label fx:id="heatmapLegendMax" text="?" styleClass="legendVal"/>
                            </HBox>
                        </VBox>
                    </HBox>

                    <!-- Grille heatmap gÃ©nÃ©rÃ©e dynamiquement -->
                    <GridPane fx:id="heatmapGrid" hgap="3" vgap="3"/>

                    <!-- CatÃ©gorie dominante par Ã¢ge -->
                    <VBox spacing="4" styleClass="dominanteBox">
                        <Label text="CatÃ©gorie dominante par tranche d'Ã¢ge" styleClass="dominanteTitle"/>
                        <Label fx:id="dominanteInfo" text="" styleClass="dominanteText" wrapText="true"/>
                    </VBox>
                </VBox>

                <!-- â•â• 2 COLONNES : Top lieux | BudgetÃ—Ã‚ge â•â• -->
                <HBox spacing="16" alignment="TOP_LEFT">

                    <!-- TOP 10 LIEUX -->
                    <VBox spacing="10" styleClass="sectionCard" HBox.hgrow="ALWAYS">
                        <Label text="ðŸ†  Top 10 Lieux" styleClass="sectionTitle"/>
                        <Label fx:id="topLieuxSubtitle" text="" styleClass="sectionSubtitle"/>
                        <VBox fx:id="topLieuxBars" spacing="4"/>
                        <HBox spacing="16" styleClass="legendRow">
                            <Label text="â†‘ En hausse cette semaine" styleClass="legendUp"/>
                            <Label text="â†“ En baisse" styleClass="legendDown"/>
                            <Label text="â†’ Stable" styleClass="legendNeutral"/>
                        </HBox>
                    </VBox>

                    <!-- BUDGET Ã— Ã‚GE -->
                    <VBox spacing="10" styleClass="sectionCard" prefWidth="320">
                        <Label text="ðŸ’°  Budget Ã— Ã‚ge" styleClass="sectionTitle"/>
                        <Label text="Distribution des tranches de budget par tranche d'Ã¢ge"
                               styleClass="sectionSubtitle"/>
                        <VBox fx:id="budgetAgeChart" spacing="6"/>
                    </VBox>
                </HBox>

                <!-- â•â• MÃ‰TRIQUES AVANCÃ‰ES â•â• -->
                <HBox spacing="16">

                    <!-- Pearson -->
                    <VBox spacing="10" styleClass="sectionCard" HBox.hgrow="ALWAYS">
                        <Label text="ðŸ“  CorrÃ©lation  Ã‚ge â†” Budget  (Pearson)" styleClass="sectionTitle"/>
                        <Label text="Mesure si les utilisateurs Ã¢gÃ©s tendent vers des lieux plus chers"
                               styleClass="sectionSubtitle"/>
                        <HBox spacing="12" alignment="CENTER_LEFT">
                            <Label fx:id="pearsonLabel" text="r = â€”" styleClass="pearsonValue"/>
                            <Label fx:id="pearsonInterp" text="" styleClass="pearsonInterp"/>
                        </HBox>
                        <HBox fx:id="pearsonGauge"/>
                        <Label text="r âˆˆ [-1,+1]  Â·  +1 = corrÃ©lation parfaite  Â·  0 = indÃ©pendance  Â·  -1 = inverse"
                               styleClass="pearsonFormula"/>
                    </VBox>

                    <!-- Shannon -->
                    <VBox spacing="10" styleClass="sectionCard" HBox.hgrow="ALWAYS">
                        <Label text="ðŸŒ  DiversitÃ© gÃ©ographique  (Shannon)" styleClass="sectionTitle"/>
                        <Label text="H = -Î£(páµ¢Â·logâ‚‚páµ¢)  Â·  mesure si une tranche d'Ã¢ge visite plusieurs villes"
                               styleClass="sectionSubtitle"/>
                        <VBox fx:id="shannonList" spacing="4"/>
                        <Label text="Hâ†’0 : mono-ville  Â·  H Ã©levÃ© : explorateur multi-villes"
                               styleClass="sectionSubtitle" wrapText="true"/>
                    </VBox>
                </HBox>

            </VBox>
        </content>
    </ScrollPane>

    <!-- Overlay chargement -->
    <StackPane fx:id="loadingOverlay" styleClass="loadingOverlay">
        <VBox spacing="14" alignment="CENTER">
            <Label fx:id="loadingLabel" text="âš™  Calcul des analyses en coursâ€¦" styleClass="loadingText"/>
            <Label text="CorrÃ©lations Â· Heatmap Â· Entropie Â· Scores" styleClass="loadingSub"/>
        </VBox>
    </StackPane>

</StackPane>
