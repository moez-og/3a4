<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sélecteur de Localisation</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; height: 100vh; background-color: #f5f5f5; }
        #map { width: 100%; height: 100%; z-index: 1; }

        .info-panel{
            position:absolute; bottom:20px; left:20px; background:white; padding:15px;
            border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.15);
            z-index:1000; max-width:340px;
        }
        .info-panel h3{ margin-bottom:8px; color:#333; }
        .info-panel p{ color:#666; font-size:12px; margin:6px 0; }
        .coordinates{
            background:#f9f9f9; padding:8px; border-radius:6px; font-family:monospace; font-size:11px; margin-top:8px;
        }
        .address{
            margin-top:8px; font-size:11px; color:#444; line-height:1.25;
            max-height:56px; overflow:hidden;
        }
        .button-group{ position:absolute; top:20px; right:20px; z-index:1000; }
        button{
            background:#007bff; color:#fff; border:none; padding:10px 14px; margin:5px;
            border-radius:8px; cursor:pointer; font-size:12px; font-weight:700;
            box-shadow:0 2px 8px rgba(0,0,0,0.15);
        }
        button:hover{ background:#0056b3; }
        button.secondary{ background:#6c757d; }
        button.secondary:hover{ background:#5a6268; }
    </style>
</head>
<body>
<div id="map"></div>

<div class="info-panel">
    <h3>Sélection de Localisation</h3>
    <p>Cliquez sur la carte pour choisir une localisation</p>

    <p id="status" style="color:#6b7280; font-size:11px; font-weight:700;">—</p>

    <div class="coordinates">
        <div>Latitude: <span id="lat">-</span></div>
        <div>Longitude: <span id="lng">-</span></div>
    </div>

    <div class="address" id="addr">Adresse: -</div>
</div>

<div class="button-group">
    <button id="confirmBtn">Valider</button>
    <button id="clearBtn" class="secondary">Réinitialiser</button>
</div>

<script>
    let selectedLocation = null;
    let marker = null;
    let selectedAddress = "";
    let lastAddressParts = [];

    // preview marker used when JavaFX changes ville/région (does not commit)
    let previewMarker = null;

    // Robustness: debounce + cache for Nominatim (avoid rate limits)
    const geocodeCache = new Map();
    let lastCenterQuery = "";
    let centerTimer = null;

    function setStatus(msg) {
        const el = document.getElementById("status");
        if (!el) return;
        el.textContent = (msg || "—").toString();
    }

    const map = L.map("map").setView([33.8869, 9.5375], 7);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 19,
    }).addTo(map);

    async function reverseGeocode(lat, lng) {
        try {
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
            const res = await fetch(url, {
                headers: { "Accept-Language": "fr" }
            });
            const data = await res.json();
            return data || null;
        } catch (e) {
            return null;
        }
    }

    function normalizeStr(s) {
        return (s == null ? "" : String(s)).replace(/\s+/g, " ").trim();
    }

    function buildAddressParts(data) {
        const addr = (data && data.address) ? data.address : {};
        // In Tunisia, governorate often comes as "state"
        const state = normalizeStr(addr.state || addr.region || "");
        const city = normalizeStr(addr.city || addr.town || addr.village || "");
        const district = normalizeStr(
            addr.suburb || addr.city_district || addr.neighbourhood || addr.quarter || addr.hamlet || ""
        );
        const county = normalizeStr(addr.county || "");
        const postcode = normalizeStr(addr.postcode || "");
        return [state, city, district, county, postcode];
    }

    // JavaFX can read this after a click (engine.executeScript)
    window.getLastAddressParts = function() {
        try { return JSON.stringify(lastAddressParts || []); }
        catch (e) { return "[]"; }
    };

    async function geocode(query) {
        const q = (query || "").trim();
        if (!q) return null;

        const key = q.toLowerCase();
        const cached = geocodeCache.get(key);
        if (cached) return cached;

        try {
            // Tunisia bias for robust centering
            const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&limit=1&countrycodes=tn&addressdetails=1`;
            const res = await fetch(url, { headers: { "Accept-Language": "fr" } });
            const data = await res.json();
            if (!Array.isArray(data) || data.length === 0) return null;
            const item = data[0];
            const lat = parseFloat(item.lat);
            const lng = parseFloat(item.lon);
            if (!isFinite(lat) || !isFinite(lng)) return null;
            const out = { lat, lng, label: item.display_name || "" };
            geocodeCache.set(key, out);
            // simple bound to avoid unbounded memory
            if (geocodeCache.size > 40) {
                const firstKey = geocodeCache.keys().next().value;
                geocodeCache.delete(firstKey);
            }
            return out;
        } catch (e) {
            return null;
        }
    }

    async function setMapCenterByQuery(query) {
        const hit = await geocode(query);
        if (!hit) return false;
        // Zoom "ville/quartier" raisonnable
        map.setView([hit.lat, hit.lng], 13);
        return true;
    }

    function setPreviewMarker(lat, lng, label) {
        try {
            if (previewMarker) {
                map.removeLayer(previewMarker);
                previewMarker = null;
            }
            previewMarker = L.circleMarker([lat, lng], {
                radius: 8,
                color: "#1e3a5f",
                weight: 2,
                fillColor: "#3b82f6",
                fillOpacity: 0.35,
                interactive: false,
            }).addTo(map);
            if (label) {
                previewMarker.bindTooltip(label, { permanent: false, direction: "top", opacity: 0.9 });
            }
        } catch (e) {}
    }

    // Expose une API simple pour JavaFX (engine.executeScript)
    window.setSearchQuery = function(q) {
        const next = (q || "").toString().trim();
        if (!next) return;
        if (next === lastCenterQuery) return;

        lastCenterQuery = next;
        if (centerTimer) clearTimeout(centerTimer);

        setStatus("Centrage…");
        centerTimer = setTimeout(async () => {
            try {
                const hit = await geocode(next);
                if (!hit) {
                    setStatus("Centrage impossible (réseau / requête)");
                    return;
                }
                map.setView([hit.lat, hit.lng], 13);
                setPreviewMarker(hit.lat, hit.lng, "Aperçu: " + next);
                setStatus("Centré sur: " + next);
            } catch (e) {
                setStatus("Centrage impossible (erreur)");
            }
        }, 550);
    };

    function publishToJavaFX(lat, lng, address) {
        // IMPORTANT: on encode une info stable pour JavaFX via document.title
        // Format: "lat,lng|address"
        const coords = `${lat.toFixed(6)},${lng.toFixed(6)}`;
        const addr = (address || "").replace(/\s+/g, " ").trim();
        document.title = addr ? `${coords}|${addr}` : coords;
    }

    map.on("click", async function (e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;

        if (marker) map.removeLayer(marker);
        if (previewMarker) {
            map.removeLayer(previewMarker);
            previewMarker = null;
        }

        marker = L.marker([lat, lng]).addTo(map)
            .bindPopup(`<b>Position sélectionnée</b><br>Lat: ${lat.toFixed(4)}<br>Lng: ${lng.toFixed(4)}`)
            .openPopup();

        document.getElementById("lat").textContent = lat.toFixed(6);
        document.getElementById("lng").textContent = lng.toFixed(6);

        selectedLocation = { latitude: lat, longitude: lng };

        // Reverse geocode (adresse)
        setStatus("Recherche d'adresse…");
        const rev = await reverseGeocode(lat, lng);
        selectedAddress = (rev && rev.display_name) ? normalizeStr(rev.display_name) : "";
        lastAddressParts = buildAddressParts(rev);
        document.getElementById("addr").textContent = selectedAddress ? ("Adresse: " + selectedAddress) : "Adresse: -";
        setStatus(selectedAddress ? "Adresse trouvée" : "Adresse introuvable");

        // On publie immédiatement à JavaFX (même sans Valider)
        publishToJavaFX(lat, lng, selectedAddress);
    });

    document.getElementById("confirmBtn").addEventListener("click", function () {
        if (!selectedLocation) {
            alert("Veuillez sélectionner une localisation sur la carte");
            return;
        }
        // Re-publier (au cas où)
        publishToJavaFX(selectedLocation.latitude, selectedLocation.longitude, selectedAddress);
    });

    document.getElementById("clearBtn").addEventListener("click", function () {
        if (marker) {
            map.removeLayer(marker);
            marker = null;
        }
        if (previewMarker) {
            map.removeLayer(previewMarker);
            previewMarker = null;
        }
        selectedLocation = null;
        selectedAddress = "";
        lastAddressParts = [];
        document.getElementById("lat").textContent = "-";
        document.getElementById("lng").textContent = "-";
        document.getElementById("addr").textContent = "Adresse: -";
        document.title = "Sélecteur de Localisation";
    });

    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(function (position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            map.setView([lat, lng], 12);
        }, function() {
            // ignore
        }, { enableHighAccuracy: false, timeout: 3500 });
    }

    // Si le HTML est chargé avec un paramètre ?q=..., centrer la map automatiquement
    try {
        const params = new URLSearchParams(window.location.search);
        const q = params.get("q");
        if (q && q.trim()) {
            setMapCenterByQuery(q.trim());
        }
    } catch (e) {}
</script>
</body>
</html>